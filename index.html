<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Net House Projects Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100%; overflow: hidden; }
        
        /* --- Login Screen --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            display: flex; justify-content: center; align-items: center;
            z-index: 99999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; width: 300px;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd;
            border-radius: 5px; box-sizing: border-box; font-size: 16px; text-align: center;
        }
        .login-btn {
            width: 100%; padding: 12px; background: #3498db; color: white;
            border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background 0.3s;
        }
        .login-btn:hover { background: #2980b9; }
        .error-msg { color: #e74c3c; font-size: 14px; margin-top: 10px; display: none; }

        /* --- Layout --- */
        #app-container { display: none; height: 100vh; position: relative; }
        
        /* Sidebar */
        #sidebar {
            width: 400px; background: #f4f6f8; border-right: 1px solid #ccc;
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); transition: transform 0.3s ease; position: relative;
        }
        @media (max-width: 768px) {
            #sidebar { position: absolute; width: 100%; height: 100%; }
            #sidebar.closed { transform: translateX(-100%); }
        }

        /* Buttons & Controls */
        #map-menu-btn {
            position: absolute; top: 10px; left: 60px; z-index: 1000;
            background: white; border: 2px solid rgba(0,0,0,0.2);
            padding: 8px 12px; border-radius: 4px; cursor: pointer;
            font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none;
        }
        @media (max-width: 768px) { #map-menu-btn { display: block; } }

        .btn-close-sidebar { background: none; border: none; color: white; font-size: 20px; cursor: pointer; display: none; }
        @media (max-width: 768px) { .btn-close-sidebar { display: block; } }

        .sidebar-header { padding: 15px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center; }
        .controls-area { padding: 10px; background: white; border-bottom: 1px solid #ddd; }
        .file-input-wrapper { display: flex; gap: 10px; margin-bottom: 10px; }
        #search-input { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 8px; }
        
        .btn-primary { background: #3498db; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 13px; flex: 1; }
        .btn-success { background: #27ae60; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 13px; flex: 1; }
        .btn-toggle { background: #8e44ad; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; }
        .btn-danger { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        /* Lists */
        #categories-container { flex: 1; overflow-y: auto; padding: 10px; padding-bottom: 50px; }
        .category-group { background: white; margin-bottom: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .category-header { padding: 10px; background: #e9ecef; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; font-weight: bold; color: #495057; border-left: 5px solid transparent; }
        .item-list { list-style: none; padding: 0; margin: 0; min-height: 10px; transition: max-height 0.3s ease; }
        .item-list.collapsed { display: none; }
        .location-item { padding: 10px; border-bottom: 1px solid #eee; background: white; display: flex; align-items: center; gap: 10px; cursor: grab; }
        .item-name { flex: 1; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Popups & Menus */
        .color-picker-trigger { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #999; margin-right: 10px; cursor: pointer; display: inline-block; }
        .color-dropdown { position: absolute; background: white; border: 1px solid #ccc; padding: 5px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 99999; display: none; width: 130px; flex-wrap: wrap; gap: 5px; }
        .color-dropdown.show { display: flex; }
        .color-option { width: 25px; height: 25px; border-radius: 3px; cursor: pointer; border: 1px solid #ddd; }
        #global-context-menu { position: fixed; background: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100000; width: 160px; border-radius: 4px; display: none; flex-direction: column; padding: 5px 0; }
        .menu-option { padding: 10px 15px; cursor: pointer; font-size: 13px; color: #333; }
        .menu-option:hover { background: #f1f1f1; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 18px; color: #6c757d; padding: 0 5px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 320px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }
        .modal-btn { display: block; width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; background: #eee; color: #333; transition: background 0.2s; }
        .modal-btn:hover { background: #ddd; }
        .btn-kml { background: #3498db; color: white; }
        .btn-geojson { background: #27ae60; color: white; }
        .btn-json { background: #f39c12; color: white; }
        .btn-close { background: #95a5a6; color: white; margin-top: 15px; }

        /* Map */
        #map { flex: 1; height: 100%; }
        /* map-label updated to support colored text and improved visibility */
        .map-label { 
            font-weight: bold; 
            border: 1px solid #ccc; 
            background: rgba(255,255,255,0.95);
            text-align: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .category-group.drag-over { border: 2px dashed #3498db; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:#2c3e50; margin-top:0;">üîê Login Required</h2>
            <p style="color:#666; font-size:14px;">Enter password to access project</p>
            <input type="password" id="password-input" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="checkLogin()">Unlock</button>
            <div id="login-error" class="error-msg">‚ùå Incorrect Password</div>
        </div>
    </div>

    <div id="app-container">
        <button id="map-menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>

        <aside id="sidebar">
            <div class="sidebar-header">
                <span>üõ†Ô∏è Net House Projects</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-danger" onclick="clearData()" title="Clear Data">üóëÔ∏è</button>
                    <button class="btn-close-sidebar" onclick="toggleSidebar()">‚úï</button>
                </div>
            </div>
            
            <div class="controls-area">
                <div class="file-input-wrapper">
                    <input type="file" id="file-input" style="display: none;">
                    <button class="btn-primary" onclick="openImportModal()">üìÇ Import</button>
                    <button class="btn-success" onclick="openExportModal()">üíæ Export</button>
                </div>
                
                <input type="text" id="search-input" placeholder="üîç Search locations..." oninput="filterItems()">
                
                <button class="btn-toggle" onclick="openLabelModal()">üè∑Ô∏è Label Options</button>
            </div>

            <div id="categories-container"></div>
        </aside>

        <main id="map"></main>
    </div>

    <div id="global-context-menu"></div>
    <div id="global-color-picker" class="color-dropdown"></div>

    <div id="export-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">üì§ Export Data</h3>
            <p>Choose format to save:</p>
            <button class="modal-btn btn-kml" onclick="exportData('kml')">üåç Export as KML</button>
            <button class="modal-btn btn-geojson" onclick="exportData('geojson')">üó∫Ô∏è Export as GeoJSON</button>
            <button class="modal-btn btn-json" onclick="exportData('json')">üì¶ Export as JSON</button>
            <button class="modal-btn btn-close" onclick="closeModal('export-modal')">Cancel</button>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">üì• Import Data</h3>
            <p>Select format to upload:</p>
            <button class="modal-btn btn-kml" onclick="triggerImport('kml')">üåç Import KML</button>
            <button class="modal-btn btn-geojson" onclick="triggerImport('geojson')">üó∫Ô∏è Import GeoJSON</button>
            <button class="modal-btn btn-json" onclick="triggerImport('json')">üì¶ Import JSON Backup</button>
            <button class="modal-btn btn-close" onclick="closeModal('import-modal')">Cancel</button>
        </div>
    </div>

    <div id="label-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">üè∑Ô∏è Label Display Options</h3>
            <p>What do you want to see on map?</p>
            <button class="modal-btn" onclick="setLabelMode('name')">Show Names Only</button>
            <button class="modal-btn" onclick="setLabelMode('group')">Show Group Status</button>
            <button class="modal-btn" onclick="setLabelMode('both')">Show Both (Name + Status)</button>
            <button class="modal-btn btn-danger" onclick="setLabelMode('none')">üö´ Hide All Labels</button>
            <button class="modal-btn btn-close" onclick="closeModal('label-modal')">Cancel</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- Login Logic ---
        function checkLogin() {
            const pass = document.getElementById('password-input').value;
            if (pass === "932927") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                initApp();
            } else {
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('password-input').value = '';
            }
        }
        document.getElementById('password-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') checkLogin(); });

        // --- Config ---
        const AVAILABLE_COLORS = ['#3498db', '#e74c3c', '#27ae60', '#f1c40f', '#e67e22', '#9b59b6', '#1abc9c', '#7f8c8d'];
        const CATEGORY_KEYS = ['Selected', 'Ready', 'WIP', 'Finished', 'Other'];
        const CATEGORY_LABELS = { 'Selected': 'Selected', 'Ready': 'Ready for work', 'WIP': 'Work in progress', 'Finished': 'Finished', 'Other': 'Other' };
        let categoryColors = { 'Selected': '#3498db', 'Ready': '#f1c40f', 'WIP': '#e67e22', 'Finished': '#27ae60', 'Other': '#7f8c8d' };
        let appData = { 'Selected': [], 'Ready': [], 'WIP': [], 'Finished': [], 'Other': [] };
        
        let map;
        let markersLayer = new L.LayerGroup();
        let draggedItem = null;
        let draggedSourceCategory = null;
        let currentImportType = null;
        let currentLabelMode = 'name'; 

        // --- Init ---
        function initApp() {
            initMap();
            loadFromStorage();
            renderSidebar();
            
            document.addEventListener('click', (e) => {
                if (document.getElementById('global-context-menu').style.display === 'flex' && !e.target.closest('.action-btn')) document.getElementById('global-context-menu').style.display = 'none';
                if (document.getElementById('global-color-picker').classList.contains('show') && !e.target.closest('.color-picker-trigger')) document.getElementById('global-color-picker').classList.remove('show');
                if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
            });
            document.getElementById('file-input').addEventListener('change', handleFileSelect);
        }

        function initMap() {
            map = L.map('map').setView([22.2587, 71.1924], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            markersLayer.addTo(map);
            document.getElementById('sidebar').addEventListener('transitionend', function() { map.invalidateSize(); });
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('closed'); }
        function openLabelModal() { document.getElementById('label-modal').style.display = 'flex'; }
        
        function setLabelMode(mode) {
            currentLabelMode = mode;
            updateMap(); 
            closeModal('label-modal');
        }

        // --- Storage ---
        function saveToStorage() {
            localStorage.setItem('kmlMapDataNetHouse', JSON.stringify(appData));
            localStorage.setItem('kmlMapColorsNetHouse', JSON.stringify(categoryColors));
            updateMap();
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('kmlMapDataNetHouse');
            const savedColors = localStorage.getItem('kmlMapColorsNetHouse');
            if (savedData) appData = JSON.parse(savedData);
            if (savedColors) categoryColors = JSON.parse(savedColors);
        }

        function clearData() {
            if(confirm("Are you sure? This will delete all saved progress.")) {
                localStorage.removeItem('kmlMapDataNetHouse');
                localStorage.removeItem('kmlMapColorsNetHouse');
                location.reload();
            }
        }

        // --- Imports/Exports ---
        function openImportModal() { document.getElementById('import-modal').style.display = 'flex'; }
        function openExportModal() { document.getElementById('export-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function triggerImport(type) {
            currentImportType = type;
            const input = document.getElementById('file-input');
            if(type === 'kml') input.accept = '.kml';
            else if(type === 'geojson') input.accept = '.geojson,.json';
            else if(type === 'json') input.accept = '.json';
            input.click();
            closeModal('import-modal');
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    if (currentImportType === 'kml') parseKML(content);
                    else if (currentImportType === 'geojson') parseGeoJSONImport(content);
                    else if (currentImportType === 'json') parseJSONBackup(content);
                } catch (err) { alert("Error importing: " + err.message); }
                document.getElementById('file-input').value = '';
            };
            reader.readAsText(file);
        }

        // --- Parsers ---
        function parseKML(xml) {
            const parser = new DOMParser(); const doc = parser.parseFromString(xml, "text/xml");
            const placemarks = doc.getElementsByTagName("Placemark");
            let count = 0;
            for(let i=0; i<placemarks.length; i++) {
                const name = placemarks[i].getElementsByTagName("name")[0]?.textContent.trim() || "Unnamed";
                if(findItemByName(name)) continue;
                const point = placemarks[i].getElementsByTagName("Point")[0];
                const poly = placemarks[i].getElementsByTagName("Polygon")[0];
                let latlng = null, type = 'unknown';
                if(point) {
                    type='point'; const c = point.getElementsByTagName("coordinates")[0].textContent.trim().split(',');
                    latlng=[parseFloat(c[1]), parseFloat(c[0])];
                } else if(poly) {
                    type='polygon'; const raw = poly.getElementsByTagName("coordinates")[0].textContent.trim().split(/\s+/);
                    latlng = raw.map(p => { const c=p.split(','); if(c.length>=2) return [parseFloat(c[1]), parseFloat(c[0])]; }).filter(p=>p);
                }
                if(latlng) { appData['Selected'].push(createItem(name, type, latlng)); count++; }
            }
            alert(count + " locations imported."); saveToStorage(); renderSidebar();
        }

        function parseGeoJSONImport(json) {
            const data = JSON.parse(json); const feats = data.features || (data.type==='Feature'?[data]:[]);
            let count = 0;
            feats.forEach(f => {
                const name = f.properties?.name || "Unnamed";
                if(findItemByName(name)) return;
                let latlng=null, type='unknown';
                if(f.geometry.type==='Point'){ type='point'; latlng=[f.geometry.coordinates[1], f.geometry.coordinates[0]]; }
                else if(f.geometry.type==='Polygon'){ type='polygon'; latlng=f.geometry.coordinates[0].map(c=>[c[1],c[0]]); }
                if(latlng) {
                    const st = f.properties.status && appData[f.properties.status] ? f.properties.status : 'Selected';
                    appData[st].push(createItem(name, type, latlng)); count++;
                }
            });
            alert(count + " locations imported."); saveToStorage(); renderSidebar();
        }

        function parseJSONBackup(json) {
            const p = JSON.parse(json);
            if(p.data && p.colors && confirm("Merge with current data?")) {
                Object.keys(p.data).forEach(k => {
                    if(appData[k]) p.data[k].forEach(i => { if(!findItemByName(i.name)) appData[k].push(i); });
                });
                categoryColors = p.colors; saveToStorage(); renderSidebar();
            }
        }

        function createItem(n, t, l) { return { id: Date.now()+Math.random().toString(36).substr(2,9), name: n, type: t, latlng: l, visible: true }; }
        function findItemByName(n) { return Object.keys(appData).some(k => appData[k].find(i => i.name === n)); }

        // --- Export ---
        function exportData(fmt) {
            let c='', f='nethouse.'+fmt, m='text/plain';
            if(fmt==='json'){ c=JSON.stringify({data:appData, colors:categoryColors},null,2); m='application/json'; }
            else if(fmt==='geojson'){ c=generateGeoJSON(); m='application/json'; }
            else if(fmt==='kml'){ c=generateKML(); m='application/vnd.google-earth.kml+xml'; }
            const b = new Blob([c], {type:m}); const l = document.createElement("a");
            l.href=URL.createObjectURL(b); l.download=f; document.body.appendChild(l); l.click(); document.body.removeChild(l);
            closeModal('export-modal');
        }
        function generateGeoJSON() {
            const f=[]; CATEGORY_KEYS.forEach(k=>{ appData[k].forEach(i=>{
                let c=i.type==='point'?[i.latlng[1],i.latlng[0]]:[i.latlng.map(p=>[p[1],p[0]])];
                f.push({type:"Feature", properties:{name:i.name, status:k, color:categoryColors[k]}, geometry:{type:i.type==='point'?"Point":"Polygon", coordinates:c}});
            })}); return JSON.stringify({type:"FeatureCollection", features:f},null,2);
        }
        function generateKML() {
            const h2k=h=>{const r=h.substring(1,3),g=h.substring(3,5),b=h.substring(5,7); return `ff${b}${g}${r}`;};
            let s='', p='';
            CATEGORY_KEYS.forEach(k=>{
                const c=h2k(categoryColors[k]);
                s+=`<Style id="style-${k}"><IconStyle><scale>1.1</scale><color>${c}</color></IconStyle><LineStyle><color>${c}</color><width>2</width></LineStyle><PolyStyle><color>7f${c.substring(2)}</color></PolyStyle></Style>`;
                appData[k].forEach(i=>{
                    let g=i.type==='point'?`<Point><coordinates>${i.latlng[1]},${i.latlng[0]},0</coordinates></Point>`:`<Polygon><outerBoundaryIs><LinearRing><coordinates>${i.latlng.map(p=>`${p[1]},${p[0]},0`).join(' ')}</coordinates></LinearRing></outerBoundaryIs></Polygon>`;
                    p+=`<Placemark><name>${i.name}</name><styleUrl>#style-${k}</styleUrl>${g}</Placemark>`;
                });
            });
            return `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>${s}${p}</Document></kml>`;
        }

        // --- Sidebar Render ---
        function renderSidebar() {
            const c = document.getElementById('categories-container'); c.innerHTML='';
            CATEGORY_KEYS.forEach(k=>{
                const grp = document.createElement('div'); grp.className='category-group';
                const col = categoryColors[k];
                const all = appData[k].length>0 && appData[k].every(i=>i.visible);
                grp.innerHTML = `<div class="category-header" style="border-left-color:${col}"><div style="display:flex; align-items:center; gap:8px;"><div class="color-picker-trigger" style="background:${col}" onclick="openColorPicker(event,'${k}')"></div><input type="checkbox" ${all?'checked':''} onclick="toggleCategory('${k}',this.checked,event)"><span onclick="toggleCollapse('${k}')">${CATEGORY_LABELS[k]} (${appData[k].length})</span></div><span onclick="toggleCollapse('${k}')">‚ñº</span></div><ul class="item-list" id="list-${k}"></ul>`;
                const ul = grp.querySelector('ul');
                ul.addEventListener('dragover',e=>{e.preventDefault(); ul.parentElement.classList.add('drag-over');});
                ul.addEventListener('dragleave',e=>{ul.parentElement.classList.remove('drag-over');});
                ul.addEventListener('drop',e=>{e.preventDefault(); ul.parentElement.classList.remove('drag-over'); handleDrop(k);});
                
                appData[k].forEach((item,idx)=>{
                    const li = document.createElement('li'); li.className='location-item'; li.draggable=true;
                    li.addEventListener('dragstart',()=>{draggedItem=item; draggedSourceCategory=k; li.classList.add('dragging');});
                    li.addEventListener('dragend',()=>{li.classList.remove('dragging'); draggedItem=null; draggedSourceCategory=null;});
                    li.innerHTML = `<input type="checkbox" ${item.visible?'checked':''} onchange="toggleItem('${k}',${idx})"><span class="item-name" onclick="zoomToItem('${k}',${idx}); if(window.innerWidth<=768) toggleSidebar();">${item.name}</span><button class="action-btn" onclick="openGlobalMenu(event,'${k}',${idx})">‚ãÆ</button>`;
                    ul.appendChild(li);
                });
                c.appendChild(grp);
            });
        }
        function toggleCollapse(k){document.getElementById(`list-${k}`).classList.toggle('collapsed');}
        function toggleCategory(k,s,e){e.stopPropagation(); appData[k].forEach(i=>i.visible=s); saveToStorage(); renderSidebar();}
        function toggleItem(k,i){appData[k][i].visible=!appData[k][i].visible; saveToStorage();}
        
        function openColorPicker(e,k){
            e.stopPropagation(); const p=document.getElementById('global-color-picker'); p.innerHTML='';
            AVAILABLE_COLORS.forEach(c=>{
                const d=document.createElement('div'); d.className='color-option'; d.style.backgroundColor=c;
                d.onclick=()=>{categoryColors[k]=c; p.classList.remove('show'); saveToStorage(); renderSidebar();}
                p.appendChild(d);
            });
            const r=e.target.getBoundingClientRect(); p.style.top=(r.bottom+5)+'px'; p.style.left=r.left+'px'; p.classList.add('show');
        }
        function openGlobalMenu(e,s,i){
            e.stopPropagation(); const m=document.getElementById('global-context-menu'); m.innerHTML='';
            CATEGORY_KEYS.forEach(t=>{ if(t!==s){
                const o=document.createElement('div'); o.className='menu-option'; o.innerText=`Move to ${CATEGORY_LABELS[t]}`;
                o.onclick=()=>{moveItem(s,i,t); m.style.display='none';}; m.appendChild(o);
            }});
            const r=e.target.getBoundingClientRect();
            m.style.top = (r.bottom+200>window.innerHeight ? r.top-200 : r.bottom+5)+'px';
            m.style.left=(r.left-100)+'px'; m.style.display='flex';
        }
        function moveItem(s,i,t){ const item=appData[s][i]; appData[s].splice(i,1); appData[t].push(item); saveToStorage(); renderSidebar(); }
        function handleDrop(t){ if(!draggedItem || !draggedSourceCategory || draggedSourceCategory===t)return; appData[draggedSourceCategory]=appData[draggedSourceCategory].filter(i=>i.id!==draggedItem.id); appData[t].push(draggedItem); saveToStorage(); renderSidebar(); }

        function zoomToItem(k,i){
            const item=appData[k][i]; if(!item.visible){item.visible=true; saveToStorage(); renderSidebar();}
            if(item.type==='point') map.flyTo(item.latlng, 16); else map.fitBounds(L.polygon(item.latlng).getBounds());
            setTimeout(()=>{markersLayer.eachLayer(l=>{if(l._latlng && Math.abs(l._latlng.lat-item.latlng[0])<0.00001)l.openPopup()})},300);
        }
        function filterItems(){
            const t=document.getElementById('search-input').value.toLowerCase();
            document.querySelectorAll('.location-item').forEach(li=>li.style.display=li.querySelector('.item-name').innerText.toLowerCase().includes(t)?'flex':'none');
        }

        // --- Map Update with Colored Text Logic ---
        function updateMap() {
            if(!map) return;
            markersLayer.clearLayers();
            CATEGORY_KEYS.forEach(key => {
                const color = categoryColors[key];
                appData[key].forEach(item => {
                    if (!item.visible) return;
                    
                    let layer;
                    if (item.type === 'point') layer = L.circleMarker(item.latlng, { radius: 8, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8 });
                    else layer = L.polygon(item.latlng, { color: color });
                    
                    layer.bindPopup(`<b>${item.name}</b><br>Status: ${CATEGORY_LABELS[key]}`);
                    
                    if (currentLabelMode !== 'none') {
                        let content = "";
                        // Apply inline style to match marker color
                        if (currentLabelMode === 'name') content = `<span style="color:${color}">${item.name}</span>`;
                        else if (currentLabelMode === 'group') content = `<span style="color:${color}">${CATEGORY_LABELS[key]}</span>`;
                        else if (currentLabelMode === 'both') content = `<span style="color:${color}">${item.name}</span><br><small style="color:${color}">${CATEGORY_LABELS[key]}</small>`;
                        
                        layer.bindTooltip(content, { 
                            permanent: true, direction: 'top', className: 'map-label', 
                            offset: item.type === 'point' ? [0, -5] : [0, 0] 
                        });
                    }
                    markersLayer.addLayer(layer);
                });
            });
        }
    </script>
</body>
</html>
